package com.alfa.api.sdk.sample.app.transactions

import com.alfa.api.sdk.sample.app.ParentIntegrationTest
import com.github.tomakehurst.wiremock.client.WireMock
import org.junit.jupiter.api.Test
import org.springframework.http.HttpHeaders
import org.springframework.http.MediaType

class TransactionsTest : ParentIntegrationTest() {
    @Test
    fun positive() {
        mockGetStatementEndpoint()

        testClient.get()
            .uri { uriBuilder ->
                uriBuilder
                    .path("/sdk/transactions")
                    .queryParam("account", "40702810323180001677")
                    .queryParam("date", "2023-01-30")
                    .queryParam("page", "1")
                    .queryParam("curFormat", "curTransfer")
                    .build()
            }
            .exchange()
            .expectStatus().isOk
            .expectBody()
            .jsonPath("$._links[0].rel").isEqualTo("prev")
            .jsonPath("$._links[0].href").isEqualTo("accountNumber=40700010000006103990&statementDate=2018-03-15&page=3")
            .jsonPath("$._links[1].rel").isEqualTo("prev")
            .jsonPath("$._links[1].href").isEqualTo("accountNumber=40700010000006103990&statementDate=2018-03-15&page=3")
            .jsonPath("$.transactions[0].documentDate").isEqualTo("2021-10-07")
            .jsonPath("$.transactions[0].operationDate").isEqualTo("2018-12-31T00:00:00Z")
            .jsonPath("$.transactions[0].amount.amount").isEqualTo(1.01)
            .jsonPath("$.transactions[0].amount.currencyName").isEqualTo("USD")
            .jsonPath("$.transactions[0].filial").isEqualTo("АО \"ТЕСТ-БАНК\"")
            .jsonPath("$.transactions[0].correspondingAccount").isEqualTo("30101810400000000225")
            .jsonPath("$.transactions[0].operationCode").isEqualTo("01")
            .jsonPath("$.transactions[0].amountRub.amount").isEqualTo(1.01)
            .jsonPath("$.transactions[0].amountRub.currencyName").isEqualTo("USD")
            .jsonPath("$.transactions[0].priority").isEqualTo("5")
            .jsonPath("$.transactions[0].uuid").isEqualTo("55daccdf-de87-3879-976c-8b8415c8caf9")
            .jsonPath("$.transactions[0].revaln").isEqualTo("ПК")
            .jsonPath("$.transactions[0].transactionId").isEqualTo("1211206MOCO#DS0000017")
            .jsonPath("$.transactions[0].debtorCode").isEqualTo(0)
            .jsonPath("$.transactions[0].extendedDebtorCode").isEqualTo(50012008)
            .jsonPath("$.transactions[0].number").isEqualTo("1843")
            .jsonPath("$.transactions[0].paymentPurpose").isEqualTo("НДС не облагается")
            .jsonPath("$.transactions[0].direction").isEqualTo("DEBIT")

            .jsonPath("$.transactions[0].curTransfer.payerBankCorrAccount").isEqualTo("30101810200000000593")
            .jsonPath("$.transactions[0].curTransfer.intermediaryBankOption").isEqualTo("D")
            .jsonPath("$.transactions[0].curTransfer.intermediaryBankName").isEqualTo("АО \"ТЕСТ-БАНК\"")
            .jsonPath("$.transactions[0].curTransfer.orderingCustomerAccount").isEqualTo("/08251801040004813")
            .jsonPath("$.transactions[0].curTransfer.orderingCustomerName").isEqualTo("ООО Радуга")
            .jsonPath("$.transactions[0].curTransfer.instructionCode").isEqualTo("instructionCode")
            .jsonPath("$.transactions[0].curTransfer.messageType").isEqualTo("103")
            .jsonPath("$.transactions[0].curTransfer.exchangeRate").isEqualTo("67,74")
            .jsonPath("$.transactions[0].curTransfer.beneficiaryBankName").isEqualTo("АО \"БАНК\"")
            .jsonPath("$.transactions[0].curTransfer.messageOriginator").isEqualTo("TESTT2P")
            .jsonPath("$.transactions[0].curTransfer.receiverCorrespondentAccount").isEqualTo("30101810400000000000")
            .jsonPath("$.transactions[0].curTransfer.regulatoryReporting").isEqualTo("/N10/NS/N4/12345678901234567890/N5/12345678901/N6/TP/N7 МS.05.2003/N8/123456789012345/N9/12.05.2003")
            .jsonPath("$.transactions[0].curTransfer.beneficiaryBankAccount").isEqualTo("TESTTT21323")
            .jsonPath("$.transactions[0].curTransfer.instructedAmount").isEqualTo("USD70,00")
            .jsonPath("$.transactions[0].curTransfer.payeeBankCorrAccount").isEqualTo("30101810200000000593")
            .jsonPath("$.transactions[0].curTransfer.transactionRelatedReference").isEqualTo("transactionRelatedReference")
            .jsonPath("$.transactions[0].curTransfer.senderCorrespondentName").isEqualTo("TESTBANK N.A. NEW YORK,NY")
            .jsonPath("$.transactions[0].curTransfer.senderCorrespondentAccount").isEqualTo("BOTKGB2L")
            .jsonPath("$.transactions[0].curTransfer.valueDateCurrencyInterbankSettledAmount").isEqualTo("130824EUR5447,34")
            .jsonPath("$.transactions[0].curTransfer.senderCorrespondentOption").isEqualTo("D")
            .jsonPath("$.transactions[0].curTransfer.intermediaryBankAccount").isEqualTo("COBADEFF")
            .jsonPath("$.transactions[0].curTransfer.payerInn").isEqualTo("7720000971")
            .jsonPath("$.transactions[0].curTransfer.senderToReceiverInformation").isEqualTo("/NZP/OT 15.03.2009. NDS NE OBLAGAETSYA")
            .jsonPath("$.transactions[0].curTransfer.receiverCorrespondentName").isEqualTo("JSC TESTBANK 3, TESTOVII PEREULOK LONDON UNITED KINGDOM")
            .jsonPath("$.transactions[0].curTransfer.payeeBankBic").isEqualTo("9611925")
            .jsonPath("$.transactions[0].curTransfer.senderCharges").isEqualTo("USD7,03")
            .jsonPath("$.transactions[0].curTransfer.payeeKpp").isEqualTo("770000001")
            .jsonPath("$.transactions[0].curTransfer.payeeAccount").isEqualTo("40802810401300015422")
            .jsonPath("$.transactions[0].curTransfer.bankOperationCode").isEqualTo("CRED")
            .jsonPath("$.transactions[0].curTransfer.transactionTypeCode").isEqualTo("S01")
            .jsonPath("$.transactions[0].curTransfer.payeeName").isEqualTo("Наименование получателя")
            .jsonPath("$.transactions[0].curTransfer.messageReceiveTime").isEqualTo("15-05-27 13:21")
            .jsonPath("$.transactions[0].curTransfer.messageDestinator").isEqualTo("TESTV2X")
            .jsonPath("$.transactions[0].curTransfer.messageIdentifier").isEqualTo("S000013082900014")
            .jsonPath("$.transactions[0].curTransfer.beneficiaryCustomerName").isEqualTo("ООО Ромашка")
            .jsonPath("$.transactions[0].curTransfer.payerName").isEqualTo("Гаврилов Добрыня Петрович")
            .jsonPath("$.transactions[0].curTransfer.urgent").isEqualTo("URGENT")
            .jsonPath("$.transactions[0].curTransfer.orderingInstitutionName").isEqualTo("АО \"ТЕСТ-БАНК\"")
            .jsonPath("$.transactions[0].curTransfer.receiverCorrespondentOption").isEqualTo("D")
            .jsonPath("$.transactions[0].curTransfer.orderingInstitutionAccount").isEqualTo("TESTJ080")
            .jsonPath("$.transactions[0].curTransfer.messageSendTime").isEqualTo("15-05-27 13:21")
            .jsonPath("$.transactions[0].curTransfer.orderingCustomerOption").isEqualTo("K")
            .jsonPath("$.transactions[0].curTransfer.detailsOfCharges").isEqualTo("OUR")
            .jsonPath("$.transactions[0].curTransfer.transactionReferenceNumber").isEqualTo(69528)
            .jsonPath("$.transactions[0].curTransfer.payerKpp").isEqualTo("770000001")
            .jsonPath("$.transactions[0].curTransfer.payerBankName").isEqualTo("АО \"ТЕСТ-БАНК\"")
            .jsonPath("$.transactions[0].curTransfer.orderingInstitutionOption").isEqualTo("D")
            .jsonPath("$.transactions[0].curTransfer.payerAccount").isEqualTo("40802810401300015422")
            .jsonPath("$.transactions[0].curTransfer.payeeBankName").isEqualTo("АО \"БАНК\"")
            .jsonPath("$.transactions[0].curTransfer.beneficiaryBankOption").isEqualTo("D")
            .jsonPath("$.transactions[0].curTransfer.remittanceInformation").isEqualTo("PAYMENT ACC AGREEMENT 1 DD 29.11.2018 FOR WATCHES")
            .jsonPath("$.transactions[0].curTransfer.beneficiaryCustomerAccount").isEqualTo("40702810701300000761")
            .jsonPath("$.transactions[0].curTransfer.payerBankBic").isEqualTo("012525593")
            .jsonPath("$.transactions[0].curTransfer.payeeInn").isEqualTo("7720000971")
            .jsonPath("$.transactions[0].curTransfer.receiverCharges").isEqualTo("receiverCharges")

            .jsonPath("$.transactions[0].swiftTransfer.bankOperationCode").isEqualTo("CRED")
            .jsonPath("$.transactions[0].swiftTransfer.intermediaryBankOption").isEqualTo("D")
            .jsonPath("$.transactions[0].swiftTransfer.intermediaryBankName").isEqualTo("АО \"ТЕСТ-БАНК\"")
            .jsonPath("$.transactions[0].swiftTransfer.orderingCustomerAccount").isEqualTo("/08251801040004813")
            .jsonPath("$.transactions[0].swiftTransfer.orderingCustomerName").isEqualTo("ООО Радуга")
            .jsonPath("$.transactions[0].swiftTransfer.transactionTypeCode").isEqualTo("S01")
            .jsonPath("$.transactions[0].swiftTransfer.instructionCode").isEqualTo("instructionCode")
            .jsonPath("$.transactions[0].swiftTransfer.messageReceiveTime").isEqualTo("15-05-27 13:21")
            .jsonPath("$.transactions[0].swiftTransfer.messageDestinator").isEqualTo("TESTV2X")
            .jsonPath("$.transactions[0].swiftTransfer.messageType").isEqualTo("103")
            .jsonPath("$.transactions[0].swiftTransfer.exchangeRate").isEqualTo("67,74")
            .jsonPath("$.transactions[0].swiftTransfer.beneficiaryBankName").isEqualTo("АО \"ТЕСТ-БАНК\"")
            .jsonPath("$.transactions[0].swiftTransfer.messageIdentifier").isEqualTo("S000013082900014")
            .jsonPath("$.transactions[0].swiftTransfer.messageOriginator").isEqualTo("TESTU2P")
            .jsonPath("$.transactions[0].swiftTransfer.receiverCorrespondentAccount").isEqualTo("30101810400000000000")
            .jsonPath("$.transactions[0].swiftTransfer.regulatoryReporting").isEqualTo("/N10/NS/N4/12345678901234567890/N5/12345678901/N6/TP/N7 МS.05.2003/N8/123456789012345/N9/12.05.2003")
            .jsonPath("$.transactions[0].swiftTransfer.beneficiaryBankAccount").isEqualTo("TEST21323")
            .jsonPath("$.transactions[0].swiftTransfer.beneficiaryCustomerName").isEqualTo("ООО Ромашка")
            .jsonPath("$.transactions[0].swiftTransfer.instructedAmount").isEqualTo("USD70,00")
            .jsonPath("$.transactions[0].swiftTransfer.transactionRelatedReference").isEqualTo("transactionRelatedReference")
            .jsonPath("$.transactions[0].swiftTransfer.urgent").isEqualTo("URGENT")
            .jsonPath("$.transactions[0].swiftTransfer.orderingInstitutionName").isEqualTo("АО \"ТЕСТ-БАНК\"")
            .jsonPath("$.transactions[0].swiftTransfer.receiverCorrespondentOption").isEqualTo("D")
            .jsonPath("$.transactions[0].swiftTransfer.senderCorrespondentName").isEqualTo("TESTBANK N.A. NEW YORK,NY")
            .jsonPath("$.transactions[0].swiftTransfer.orderingInstitutionAccount").isEqualTo("TESTBJ080")
            .jsonPath("$.transactions[0].swiftTransfer.senderCorrespondentAccount").isEqualTo("TESTGB2L")
            .jsonPath("$.transactions[0].swiftTransfer.valueDateCurrencyInterbankSettledAmount").isEqualTo("130824EUR5447,34")
            .jsonPath("$.transactions[0].swiftTransfer.senderCorrespondentOption").isEqualTo("D")
            .jsonPath("$.transactions[0].swiftTransfer.messageSendTime").isEqualTo("15-05-27 13:21")
            .jsonPath("$.transactions[0].swiftTransfer.orderingCustomerOption").isEqualTo("K")
            .jsonPath("$.transactions[0].swiftTransfer.detailsOfCharges").isEqualTo("OUR")
            .jsonPath("$.transactions[0].swiftTransfer.intermediaryBankAccount").isEqualTo("TESTEFF")
            .jsonPath("$.transactions[0].swiftTransfer.transactionReferenceNumber").isEqualTo(69528)
            .jsonPath("$.transactions[0].swiftTransfer.orderingInstitutionOption").isEqualTo("D")
            .jsonPath("$.transactions[0].swiftTransfer.senderToReceiverInformation").isEqualTo("/NZP/OT 15.03.2009. NDS NE OBLAGAETSYA")
            .jsonPath("$.transactions[0].swiftTransfer.receiverCorrespondentName").isEqualTo("JSC TESTBANK 3, TESTOVII PEREULOK LONDON UNITED KINGDOM")
            .jsonPath("$.transactions[0].swiftTransfer.beneficiaryBankOption").isEqualTo("D")
            .jsonPath("$.transactions[0].swiftTransfer.remittanceInformation").isEqualTo("PAYMENT ACC AGREEMENT 1 DD 29.11.2018 FOR WATCHES")
            .jsonPath("$.transactions[0].swiftTransfer.beneficiaryCustomerAccount").isEqualTo("40702810701300000761")
            .jsonPath("$.transactions[0].swiftTransfer.senderCharges").isEqualTo("USD7,03")
            .jsonPath("$.transactions[0].swiftTransfer.receiverCharges").isEqualTo("receiverCharges")

            .jsonPath("$.transactions[0].rurTransfer.payerBankCorrAccount").isEqualTo("30101810200000000593")
            .jsonPath("$.transactions[0].rurTransfer.departmentalInfo.drawerStatus101").isEqualTo("1")
            .jsonPath("$.transactions[0].rurTransfer.departmentalInfo.oktmo").isEqualTo("11605000")
            .jsonPath("$.transactions[0].rurTransfer.departmentalInfo.kbk").isEqualTo("39210202010061000160")
            .jsonPath("$.transactions[0].rurTransfer.departmentalInfo.taxPeriod107").isEqualTo("МС.03.2016")
            .jsonPath("$.transactions[0].rurTransfer.departmentalInfo.docNumber108").isEqualTo("123")
            .jsonPath("$.transactions[0].rurTransfer.departmentalInfo.reasonCode106").isEqualTo("ТП")
            .jsonPath("$.transactions[0].rurTransfer.departmentalInfo.docDate109").isEqualTo("31.12.2018")
            .jsonPath("$.transactions[0].rurTransfer.departmentalInfo.uip").isEqualTo("32221003200126505006")
            .jsonPath("$.transactions[0].rurTransfer.departmentalInfo.paymentKind110").isEqualTo("1")
            .jsonPath("$.transactions[0].rurTransfer.payerKpp").isEqualTo("770000001")
            .jsonPath("$.transactions[0].rurTransfer.receiptDate").isEqualTo("2018-12-31")
            .jsonPath("$.transactions[0].rurTransfer.deliveryKind").isEqualTo("электронно")
            .jsonPath("$.transactions[0].rurTransfer.payerBankName").isEqualTo("АО \"ТЕСТ-БАНК\"")
            .jsonPath("$.transactions[0].rurTransfer.payerInn").isEqualTo("7720000971")
            .jsonPath("$.transactions[0].rurTransfer.valueDate").isEqualTo("2018-12-31")
            .jsonPath("$.transactions[0].rurTransfer.cartInfo.documentCode").isEqualTo("documentCode")
            .jsonPath("$.transactions[0].rurTransfer.cartInfo.documentDate").isEqualTo("2019-10-19T06:33:47.923Z")
            .jsonPath("$.transactions[0].rurTransfer.cartInfo.restAmount").isEqualTo("restAmount")
            .jsonPath("$.transactions[0].rurTransfer.cartInfo.documentNumber").isEqualTo("documentNumber")
            .jsonPath("$.transactions[0].rurTransfer.cartInfo.documentContent").isEqualTo("documentContent")
            .jsonPath("$.transactions[0].rurTransfer.cartInfo.paymentNumber").isEqualTo("paymentNumber")
            .jsonPath("$.transactions[0].rurTransfer.payerAccount").isEqualTo("40802810401300015422")
            .jsonPath("$.transactions[0].rurTransfer.payeeName").isEqualTo("Наименование получателя")
            .jsonPath("$.transactions[0].rurTransfer.payeeBankName").isEqualTo("АО \"ТЕСТ-БАНК\"")
            .jsonPath("$.transactions[0].rurTransfer.payeeBankBic").isEqualTo("9611925")
            .jsonPath("$.transactions[0].rurTransfer.payerBankBic").isEqualTo("012525593")
            .jsonPath("$.transactions[0].rurTransfer.purposeCode").isEqualTo("1")
            .jsonPath("$.transactions[0].rurTransfer.payeeInn").isEqualTo("7720000971")
            .jsonPath("$.transactions[0].rurTransfer.payerName").isEqualTo("Гаврилов Добрыня Петрович")
            .jsonPath("$.transactions[0].rurTransfer.payeeBankCorrAccount").isEqualTo("30101810200000000593")
            .jsonPath("$.transactions[0].rurTransfer.payeeKpp").isEqualTo("770000001")
            .jsonPath("$.transactions[0].rurTransfer.payeeAccount").isEqualTo("40802810401300015422")
            .jsonPath("$.transactions[0].rurTransfer.payingCondition").isEqualTo("payingCondition")
    }

    @Test
    fun negativeError404() {
        testClient.get()
            .uri { uriBuilder ->
                uriBuilder
                    .path("/sdk/transactions")
                    .queryParam("account", "40702810323180001677")
                    .queryParam("date", "2023-01-30")
                    .queryParam("page", "1")
                    .queryParam("curFormat", "curTransfer")
                    .build()
            }
            .exchange()
            .expectStatus().isNotFound
    }

    @Test
    fun negativeError500() {
        mockGetEndpointWithInternalError("/api/statement/transactions(.+)")

        testClient.get()
            .uri { uriBuilder ->
                uriBuilder
                    .path("/sdk/transactions")
                    .queryParam("account", "40702810323180001677")
                    .queryParam("date", "2023-01-30")
                    .queryParam("page", "1")
                    .queryParam("curFormat", "curTransfer")
                    .build()
            }
            .exchange()
            .expectStatus().is5xxServerError
    }

    private fun mockGetStatementEndpoint() {
        wiremock.stubFor(
            WireMock.get(WireMock.urlMatching("/api/statement/transactions(.+)"))
                .withQueryParam("accountNumber", WireMock.equalTo("40702810323180001677"))
                .withQueryParam("statementDate", WireMock.equalTo("2023-01-30"))
                .withQueryParam("page", WireMock.equalTo("1"))
                .withQueryParam("curFormat", WireMock.equalTo("curTransfer"))
                .willReturn(
                    WireMock.aResponse().withStatus(200)
                        .withHeader(HttpHeaders.CONTENT_TYPE, MediaType.APPLICATION_JSON_VALUE)
                        .withBody(getMockBodyFromResources("mocks/transactions/statement.json"))
                )
        )
    }
}
